---
title: "HW03"
author: "Jie Ren"
date: "March 5, 2019"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```
### Exercise 1: Data Description
```{r message=FALSE, warning=FALSE}
rm(list=ls())
# install.packages("bayesm")
# install.packages("data.table")
# install.packages("mlogit")
library("mlogit")
library("bayesm")
library("data.table")

data("margarine")
choicePrice <- margarine$choicePrice
demos       <- margarine$demos
```
#### Avg and Sd of Price by characteristic (Stk/Tub)
```{r}
# Extract price data by Char
Stk <- as.matrix(choicePrice[,grepl("Stk",colnames(choicePrice))])
Tub <- as.matrix(choicePrice[,grepl("Tub",colnames(choicePrice))])

# Calculate the Avg and Sd 
byChar           <- data.frame(average = c(mean(Stk),mean(Tub)), sd = c(sd(Stk),sd(Tub)))
rownames(byChar) <- c("Stk","Tub")
byChar
```
#### Market Share by Brand and by Charicteristic
```{r paged.print=TRUE}
# Mark the chosen one
choicePrice$chosen      <- colnames(choicePrice[,-(1:2)])[choicePrice$choice]
choicePrice$chosenChar  <- sapply(strsplit(choicePrice$chosen, "_"), "[[", 2) 
choicePrice$chosenBrand <- sapply(strsplit(choicePrice$chosen, "_"), "[[", 1) 

# Market Share by Brand 
table(choicePrice$chosenBrand)/nrow(choicePrice)

# Market Share by Char
table(choicePrice$chosenChar)/nrow(choicePrice)
```
#### Mapping between observed attributes and choices
```{r paged.print=TRUE}
choicePrice <- merge(choicePrice, demos, by = "hhid", all.x = TRUE)

lapply(choicePrice[,c("Income", "Fs3_4","Fs5.","Fam_Size", "college", "whtcollar", "retired")],
                         function(x) xtabs(~x + choicePrice$chosen))

```
### Exercise 2: First Model
This is a condiciotnal logit model, as price is alternative specific.
```{r}
# check with mlogit
Ch <- data.frame(choicePrice)
setnames(Ch, old = c("PPk_Stk", "PBB_Stk", "PFl_Stk", "PHse_Stk", "PGen_Stk", "PImp_Stk", "PSS_Tub", "PPk_Tub", "PFl_Tub", "PHse_Tub"), new = c("Price1","Price2","Price3","Price4","Price5","Price6","Price7","Price8","Price9","Price10"))

Ch <- mlogit.data(Ch, shape = "wide", varying = 3:12, choice = "choice", sep = "", alt.levels = 1:10)

# mlogit(choice ~ 0 | Income + Fam_Size + college + whtcollar + retired, data = Ch, method = "nr")
result.2.m <- mlogit(choice ~ Price, data = Ch, method = "nr")
summary(result.2.m)

```
Interpretation: The negative sign on the price coefficient indicating that as the price of one alternative increases, the individual is less likly to buy that alternative.
```{r}
# Manually
b   <- c(rep(-1,10))
Ch1 <- data.frame(Ch)

LL.p <- function(b){
  Ch1$constant <- 0
  # calculate the latent utility
  for (i in 2:10) Ch1$constant[Ch1$alt == i] <- b[i-1] # assign constant for each alternatives
  Ch1$U <- b[10]*Ch1$Price + Ch1$constant # the latent utility
  
  # calulate the choice probability for each individual (Nominator/denominator)
  D <- aggregate (Ch1["U"], Ch1[c("chid")], function(x) sum(exp(x)))["U"]
  N <- exp(Ch1[Ch1$choice == TRUE,"U"])
  P <- N/D
  return(sum(-log(P)))
}

result.2 <- optim(par = b, LL.p)
result.2$par
result.2$value
```
### Exercise 3: Second Model
This is a multinomial logit model, as income is individual specific.
```{r}
# check with mlogit
result.3.m <- mlogit(choice ~ 0 | Income, data = Ch, method = "nr")
summary(result.3.m)

```
Interpretation: 
2:Income   -0.0030887: More income, less likely to choose choice 2 over choice 1. 
3:Income    0.0145862: More income, more likely to choose choice 3 over choice 1.
4:Income    0.0040504: More income, more likely to choose choice 4 over choice 1.
5:Income   -0.0012536: More income, less likely to choose choice 5 over choice 1.  
6:Income    0.0306120: More income, more likely to choose choice 6 over choice 1.
7:Income   -0.0069326: More income, less likely to choose choice 7 over choice 1. 
8:Income    0.0228862: More income, more likely to choose choice 8 over choice 1.
9:Income    0.0177430: More income, more likely to choose choice 9 over choice 1.
10:Income   0.0107909: More income, more likely to choose choice 10 over choice 1.
```{r}
b <- c(rep(-2,9),rep(0.01,9))
Ch2 <- data.frame(Ch)

LL.p <- function(b){
  Ch2$constant    <- 0
  Ch2$beta_income <- 0
  # calculate the latent utility
  for (i in 2:10) Ch2$constant[Ch2$alt == i]    <- b[i-1] # assign constant for each alternatives
  for (i in 2:10) Ch2$beta_income[Ch2$alt == i] <- b[i+8] # assign beta for each alternatives
  Ch2$U <- Ch2$beta_income*Ch2$Income + Ch2$constant # the latent utility
  
  # calulate the choice probability for each individual (Nominator/denominator)
  D <- aggregate (Ch2["U"], Ch2[c("chid")], function(x) sum(exp(x)))["U"]
  N <- exp(Ch2[Ch2$choice == TRUE,"U"])
  P <- N/D
  return(-sum(log(P)))
}

result.3 <- optim(par = b, LL.p)
result.3$par
result.3$value
```
### Exercise 4: Marginal Effects
```{r}
# fitted mean choice probability
apply(fitted(result.2.m, outcome=FALSE), 2, mean)
apply(fitted(result.3.m, outcome=FALSE), 2, mean)

# Manually

```

### Exercise 5: IIA
```{r}

```



