---
title: "HW03"
author: "Jie Ren"
date: "March 5, 2019"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```
### Exercise 1: Data Description
```{r message=FALSE, warning=FALSE}
rm(list=ls())
# install.packages("bayesm")
# install.packages("data.table")
# install.packages("mlogit")
library("mlogit")
library("bayesm")
library("data.table")

data("margarine")
choicePrice <- margarine$choicePrice
demos       <- margarine$demos
```
#### Avg and Sd of Price by characteristic (Stk/Tub)
```{r message=FALSE, paged.print=FALSE}
# Extract price data by Char
Stk <- as.matrix(choicePrice[,grepl("Stk",colnames(choicePrice))])
Tub <- as.matrix(choicePrice[,grepl("Tub",colnames(choicePrice))])

# Calculate the Avg and Sd 
byChar           <- data.frame(average = c(mean(Stk),mean(Tub)), sd = c(sd(Stk),sd(Tub)))
rownames(byChar) <- c("Stk","Tub")
byChar
```
#### Market Share by Brand and by Charicteristic
```{r paged.print=TRUE}
# Mark the chosen one
choicePrice$chosen      <- colnames(choicePrice[,-(1:2)])[choicePrice$choice]
choicePrice$chosenChar  <- sapply(strsplit(choicePrice$chosen, "_"), "[[", 2) 
choicePrice$chosenBrand <- sapply(strsplit(choicePrice$chosen, "_"), "[[", 1) 

# Market Share by Brand 
table(choicePrice$chosenBrand)/nrow(choicePrice)

# Market Share by Char
table(choicePrice$chosenChar)/nrow(choicePrice)
```
#### Mapping between observed attributes and choices
```{r paged.print=TRUE}
choicePrice <- merge(choicePrice, demos, by = "hhid", all.x = TRUE)

lapply(choicePrice[,c("Income", "Fs3_4","Fs5.","Fam_Size", "college", "whtcollar", "retired")],
                         function(x) xtabs(~x + choicePrice$chosen))

```
### Exercise 2: First Model
This is a condiciotnal logit model, as price is alternative specific.
#### Check with mlogit
```{r}
Ch <- data.frame(choicePrice)
setnames(Ch, old = c("PPk_Stk", "PBB_Stk", "PFl_Stk", "PHse_Stk", "PGen_Stk", "PImp_Stk", "PSS_Tub", "PPk_Tub", "PFl_Tub", "PHse_Tub"), new = c("Price1","Price2","Price3","Price4","Price5","Price6","Price7","Price8","Price9","Price10"))

# Reshape the data for mlogit function
Ch <- mlogit.data(Ch, shape = "wide", varying = 3:12, choice = "choice", sep = "", alt.levels = 1:10)

# Regress using the mlogit function
result.2.m <- mlogit(choice ~ Price, data = Ch, method = "nr")
summary(result.2.m)
```
Interpretation: The negative sign on the price coefficient indicating that as the price of one alternative increases, the individual is less likly to buy that alternative.
#### Manually
```{r}
n   <- nrow(choicePrice)
b   <- rep(-1,10)

LL.2 <- function(b){
  c  <- cbind(0, t(replicate(n,b[1:9]))) # Calculate the constants
  Xb   <- as.matrix(choicePrice[,3:12])*b[10] # Calculate latent utility for alternative specific char
  XB  <- Xb + c # Calculate latent utility
  P   <- exp(XB)/rowSums(exp(XB)) # Calculate probability
  LL  <- sum(-log(P[cbind(seq(n),choicePrice$choice)])) # Only use the prob for choice that is selected
  return(LL)
}

result.2 <- optim(par = b, LL.2)
result.2$par
result.2$value
```
### Exercise 3: Second Model
This is a multinomial logit model, as income is individual specific.
#### check with mlogit
```{r}
result.3.m <- mlogit(choice ~ 0 | Income, data = Ch, method = "nr")
summary(result.3.m)
```
Interpretation: 
2:Income   -0.0030887: More income, less likely to choose choice 2 over choice 1. 
3:Income    0.0145862: More income, more likely to choose choice 3 over choice 1.
4:Income    0.0040504: More income, more likely to choose choice 4 over choice 1.
5:Income   -0.0012536: More income, less likely to choose choice 5 over choice 1.  
6:Income    0.0306120: More income, more likely to choose choice 6 over choice 1.
7:Income   -0.0069326: More income, less likely to choose choice 7 over choice 1. 
8:Income    0.0228862: More income, more likely to choose choice 8 over choice 1.
9:Income    0.0177430: More income, more likely to choose choice 9 over choice 1.
10:Income   0.0107909: More income, more likely to choose choice 10 over choice 1.
#### Mannually
```{r}
b <- c(-1,-2,-1,-2,-4,-1,-3,-2,-4,rep(0,9))

LL.3 <- function(b){
  c <- cbind(0, t(replicate(n,b[1:9]))) # Calculate the constants
  Xb <- cbind(0, t(replicate(n,b[10:18])))*choicePrice$Income # Calculate latent utility for individual specific char
  XB <- Xb+c # Calculate latent utility
  P <- exp(XB)/rowSums(exp(XB)) # Calculate probability
  LL <- sum(-log(P[cbind(seq(n),choicePrice$choice)])) # Only use the prob for choice that is selected
  return(LL)
}
result.3 <- optim(par = b, LL.3)
result.3$par
result.3$value
```
### Exercise 4: Marginal Effects
```{r}
# fitted mean choice probability
apply(fitted(result.2.m, outcome=FALSE), 2, mean)
apply(fitted(result.3.m, outcome=FALSE), 2, mean)

# Manually

```

### Exercise 5: IIA
```{r}

```



